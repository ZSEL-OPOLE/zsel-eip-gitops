apiVersion: v1
kind: ConfigMap
metadata:
  name: user-ad-init-script
  namespace: identity-system
  labels:
    app.kubernetes.io/name: user-ad
    app.kubernetes.io/component: samba-ad-dc
    app.kubernetes.io/part-of: user-services
data:
  init-domain.sh: |
    #!/bin/bash
    set -euo pipefail
    
    echo "[INFO] Starting User AD Domain Initialization (ad.zsel.opole.pl)..."
    
    # Check if domain already provisioned
    if [ -f /var/lib/samba/private/sam.ldb ]; then
      echo "[INFO] Domain already provisioned. Starting Samba AD DC..."
      exec samba -i --foreground --no-process-group
    fi
    
    echo "[INFO] Provisioning new domain: ad.zsel.opole.pl"
    
    # Provision domain
    samba-tool domain provision \
      --realm=AD.ZSEL.OPOLE.PL \
      --domain=ZSEL \
      --adminpass="$SAMBA_ADMIN_PASSWORD" \
      --server-role=dc \
      --dns-backend=SAMBA_INTERNAL \
      --use-rfc2217
    
    # Create Organizational Units for Users
    echo "[INFO] Creating Organizational Units for Users..."
    
    samba-tool ou create "OU=Users,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    samba-tool ou create "OU=Teachers,OU=Users,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    samba-tool ou create "OU=Students,OU=Users,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    samba-tool ou create "OU=Alumni,OU=Users,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    
    # Create OUs for Groups
    samba-tool ou create "OU=Groups,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    samba-tool ou create "OU=DepartmentGroups,OU=Groups,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    samba-tool ou create "OU=ClassGroups,OU=Groups,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    
    # Create OUs for Service Accounts (SSO applications)
    samba-tool ou create "OU=ServiceAccounts,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    samba-tool ou create "OU=SSOApps,OU=ServiceAccounts,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    
    # Create SSO LDAP bind service accounts
    echo "[INFO] Creating SSO service accounts..."
    
    # Moodle LDAP bind
    samba-tool user create sso-moodle-bind "$(cat /dev/urandom | tr -dc 'A-Za-z0-9' | fold -w 32 | head -n 1)" \
      --description="Service account for Moodle SSO LDAP bind" \
      --must-change-at-next-login=no || true
    samba-tool user setexpiry sso-moodle-bind --noexpiry || true
    samba-tool user move sso-moodle-bind "OU=SSOApps,OU=ServiceAccounts,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    
    # BigBlueButton LDAP bind
    samba-tool user create sso-bbb-bind "$(cat /dev/urandom | tr -dc 'A-Za-z0-9' | fold -w 32 | head -n 1)" \
      --description="Service account for BigBlueButton SSO LDAP bind" \
      --must-change-at-next-login=no || true
    samba-tool user setexpiry sso-bbb-bind --noexpiry || true
    samba-tool user move sso-bbb-bind "OU=SSOApps,OU=ServiceAccounts,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    
    # Nextcloud LDAP bind
    samba-tool user create sso-nextcloud-bind "$(cat /dev/urandom | tr -dc 'A-Za-z0-9' | fold -w 32 | head -n 1)" \
      --description="Service account for Nextcloud SSO LDAP bind" \
      --must-change-at-next-login=no || true
    samba-tool user setexpiry sso-nextcloud-bind --noexpiry || true
    samba-tool user move sso-nextcloud-bind "OU=SSOApps,OU=ServiceAccounts,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    
    # WiFi Captive Portal RADIUS bind
    samba-tool user create sso-wifi-bind "$(cat /dev/urandom | tr -dc 'A-Za-z0-9' | fold -w 32 | head -n 1)" \
      --description="Service account for WiFi RADIUS LDAP bind (captive portal)" \
      --must-change-at-next-login=no || true
    samba-tool user setexpiry sso-wifi-bind --noexpiry || true
    samba-tool user move sso-wifi-bind "OU=SSOApps,OU=ServiceAccounts,DC=ad,DC=zsel,DC=opole,DC=pl" || true
    
    # Create domain groups
    echo "[INFO] Creating domain groups..."
    samba-tool group add "Teachers" --description="All teachers" || true
    samba-tool group add "Students" --description="All students" || true
    samba-tool group add "IT-Admins" --description="IT Administrators" || true
    
    # Set password policy (strict for users)
    echo "[INFO] Setting password policy..."
    samba-tool domain passwordsettings set --complexity=on
    samba-tool domain passwordsettings set --min-pwd-length=12
    samba-tool domain passwordsettings set --min-pwd-age=1
    samba-tool domain passwordsettings set --max-pwd-age=90
    samba-tool domain passwordsettings set --history-length=24
    
    echo "[INFO] Domain provisioning complete!"
    echo "[INFO] Starting Samba AD DC..."
    
    exec samba -i --foreground --no-process-group
