apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: mattermost
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "25"
spec:
  project: education
  source:
    repoURL: https://helm.mattermost.com
    targetRevision: 6.6.0
    chart: mattermost-team-edition
    helm:
      values: |
        replicaCount: 2
        
        image:
          tag: "9.2.0"
        
        resources:
          requests:
            cpu: 1000m
            memory: 4Gi
          limits:
            cpu: 2000m
            memory: 8Gi
        
        persistence:
          data:
            enabled: true
            size: 100Gi
            storageClass: longhorn-tier2-standard
          plugins:
            enabled: true
            size: 10Gi
            storageClass: longhorn-tier2-standard
        
        externalDB:
          enabled: true
          externalDriverType: "postgres"
          externalConnectionString: "postgres://mattermost:SEALED_SECRET@postgres-ha-pgpool.db-postgres.svc.cluster.local:5432/mattermost?sslmode=disable"
        
        ingress:
          enabled: true
          className: traefik
          hosts:
            - mattermost.zsel.opole.pl
          tls:
            - secretName: mattermost-tls
              hosts:
                - mattermost.zsel.opole.pl
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-prod
        
        config:
          SiteURL: "https://mattermost.zsel.opole.pl"
          EnableOAuthServiceProvider: true
          EnableIncomingWebhooks: true
          EnableOutgoingWebhooks: true
          EnableCommands: true
          MaxFileSize: 104857600  # 100MB
          
          # LDAP/SAML configuration via Keycloak
          EnableSAML: true
          IdpURL: "https://sso.zsel.opole.pl/realms/zsel"
          IdpDescriptorURL: "https://sso.zsel.opole.pl/realms/zsel/protocol/saml/descriptor"
          ServiceProviderIdentifier: "mattermost"
          
          # Email notifications
          SendEmailNotifications: true
          SMTPServer: "mailu-front.com-mailu.svc.cluster.local"
          SMTPPort: 587
          SMTPUsername: "noreply@zsel.opole.pl"
  
  destination:
    server: https://kubernetes.default.svc
    namespace: edu-mattermost
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
