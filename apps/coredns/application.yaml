apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: coredns-custom
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "10"
spec:
  project: core-infra
  source:
    repoURL: https://coredns.github.io/helm
    targetRevision: 1.29.0
    chart: coredns
    helm:
      values: |
        replicaCount: 2
        
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        service:
          type: ClusterIP
          clusterIP: 10.43.0.10  # K3s default DNS IP
        
        serviceMonitor:
          enabled: true
        
        servers:
          - zones:
              - zone: .
            port: 53
            plugins:
              - name: errors
              - name: health
                configBlock: |-
                  lameduck 5s
              - name: ready
              - name: kubernetes
                parameters: cluster.local in-addr.arpa ip6.arpa
                configBlock: |-
                  pods insecure
                  fallthrough in-addr.arpa ip6.arpa
                  ttl 30
              - name: prometheus
                parameters: 0.0.0.0:9153
              - name: forward
                parameters: . 192.168.30.50:53  # FreeIPA DNS
                configBlock: |-
                  except zsel.opole.pl bcu.com.pl sue.opole.pl
              - name: cache
                parameters: 30
              - name: loop
              - name: reload
              - name: loadbalance
          
          # Domain-specific forwarding to FreeIPA
          - zones:
              - zone: zsel.opole.pl
              - zone: bcu.com.pl
              - zone: sue.opole.pl
              - zone: mrsu.pl
              - zone: elektryk.opole.pl
              - zone: k4tec.pl
            port: 53
            plugins:
              - name: errors
              - name: cache
                parameters: 30
              - name: forward
                parameters: . 192.168.30.50:53
                configBlock: |-
                  policy sequential
        
        affinity:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: coredns
                topologyKey: kubernetes.io/hostname
  
  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
